<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Mini Data-Binding Demo</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    /*ul { list-style: none; padding: 0; }
    li { margin: 0.5rem 0; }*/
    button { margin-top: 1rem; padding: 0.5rem 1rem; }
  </style>
</head>
<body>

<div id="headline">
    <input id="name" value="{{ name }}">
    <h1>Willkommen, {{ name }}!</h1>
    <p>Hallo {{ name }}</p>

  <!-- IF-Direktive -->
  <if test="showCondTitle">
    <h1>bedingtes Willkommen, {{ name }}!</h1>

    <if test="showCondTitle2">
      <h2>bedingtes Willkommen, {{ name }}!</h2>
    </if>
  </if>
</div>

<div id="main">
  <!-- EACH-Direktive -->
  <ul>

    <each of="items" as="item">
      <li>{{ item.name }} ({{ item.age }} Jahre)</li>
      <ul>
        <div>TEST</div>
        <each of="item.children" as="child">
            <li>{{ child.name }}</li>
        </each>
      </ul>
    </each>
  </ul>

  <button id="push">Push</button>
  <button id="pop">Pop</button>

  <button id="toggle">Titel umschalten</button>
</div>

<script>

  // -----------------------------
  // Mini-Reaktivität
  // -----------------------------
  function reactive(obj, callback) {
    return new Proxy(obj, {
      get(target, prop) {
        const value = target[prop];
        if (value && typeof value === 'object') return reactive(value, callback);
        return value;
      },
      set(target, prop, value) {
        target[prop] = value;
        callback();
        return true;
      }
    });
  }

  function getDirectInnerText(el) {
    return Array.from(el.childNodes)
      .filter(node => node.nodeType === Node.TEXT_NODE)
      .map(node => node.textContent.trim())
      .join("");
  }


  // -----------------------------
  // Renderer für <if> und <each>
  // -----------------------------

function expandEachTag(eachElement, model, context = {}) {
  const arrayName = eachElement.getAttribute('of');   // z.B. "items" oder "item.children"
  const asName = eachElement.getAttribute('as') || 'item'; // Standardname "item"

  // Array auswerten (Pfad im Kontext/Model auflösen)
  const items = resolvePath(arrayName, model, context) || [];
  const results = [];

  items.forEach(item => {
    const newContext = { ...context, [asName]: item }; // Kontext erweitern
    const children = expandChildren(eachElement, model, newContext);
    results.push(...children);
  });

  return results;
}

function expandTemplate(templateElement, model, context = {}) {
  if (templateElement.tagName === 'EACH') {
    return expandEachTag(templateElement, model, context);
  }

  // normales DOM-Element erzeugen
  const newEl = document.createElement(templateElement.tagName);
  newEl.dataset.cloned = true;

  // direkten Text des Template-Elements holen und Platzhalter ersetzen
  const directInnerText = getDirectInnerText(templateElement);
  if (directInnerText) {
    newEl.innerText = directInnerText.replace(
      /\{\{\s*([\w.-]+)\s*\}\}/g,
      (_, key) => {
        const value = resolvePath(key, model, context);
        return value !== undefined ? value : "";
      }
    );
  }

  // Kinder expandieren
  const children = expandChildren(templateElement, model, context);
  children.forEach(c => newEl.appendChild(c));

  return [newEl];
}

function expandChildren(parentTemplate, model, context = {}) {
  const results = [];
  const childTemplates = parentTemplate.querySelectorAll(':scope > *');

  childTemplates.forEach(childTemplate => {
    const expanded = expandTemplate(childTemplate, model, context);
    results.push(...expanded);
  });

  return results;
}

function render(root, model) {
  const rootChildren = root.querySelectorAll(':scope > *');

  rootChildren.forEach(child => {
    const parent = child.parentNode;

    if (child.tagName === 'EACH') {
      const oldClonedElements = parent.querySelectorAll('[data-cloned="true"]');
      oldClonedElements.forEach(oCE => oCE.remove());

      const expanded = expandEachTag(child, model);

      expanded.forEach(el => parent.insertBefore(el, child));
      child.style.display = 'none';
    } else if (child.tagName === 'IF') {
      const testExpr = child.getAttribute('test');
      const value = resolvePath(testExpr, model, {});

      // Beim ersten Mal die Kinder als Template sichern
      if (!child.dataset.ifTemplateSaved) {
        child.dataset.ifTemplateSaved = "true";
        child.dataset.ifTemplateHTML = child.innerHTML;
      }

      // Vorherige gerenderte Kinder entfernen
      child.innerHTML = "";

      if (value) {
        child.innerHTML = child.dataset.ifTemplateHTML;
        render(child, model); // rekursiv rendern
      }
    } else {
      // Prüfen: hat dieses Element {{ ... }} im direkten Text oder Attributen?
      const directInnerText = child.dataset.templateInnerText || getDirectInnerText(child);
      const hasInterpolation =
        (directInnerText && /\{\{.*?\}\}/.test(directInnerText)) ||
        Array.from(child.attributes).some(attr => /\{\{.*?\}\}/.test(attr.value));

      if (hasInterpolation) {
        child.dataset.templateInnerText = directInnerText
        child.innerText = directInnerText.replace(
          /\{\{\s*([\w.-]+)\s*\}\}/g,
          (_, key) => {
            const value = resolvePath(key, model, {});
            return value !== undefined ? value : "";
          }
        );
      }

      render(child, model);
    }
  });
}

// Hilfsfunktion: löst "item.children" oder "modelKey.subKey" im Kontext/Model auf
function resolvePath(path, model, context) {
  const parts = path.split('.');
  let current = context.hasOwnProperty(parts[0]) ? context[parts[0]] : model[parts[0]];

  for (let i = 1; i < parts.length; i++) {
    if (current == null) return undefined;
    current = current[parts[i]];
  }
  return current;
}

  const headlineModel = reactive({
    showCondTitle: true,
    showCondTitle2: true,
    name: 'Tobias'
  }, () => render(document.getElementById('headline'), headlineModel))

  const mainModel = reactive({
    items: [
      { name: 'Alice', age: 25, children: [ { name: 'Alice_1', age: 10, children: [ { name: 'Alice_1_1', age: 5 } ] } ] },
      { name: 'Bob', age: 30 },
      { name: 'Charlie', age: 20, children: [ { name: 'Charlie_1', age: 5 } ] }
    ]
  }, () => render(document.getElementById('main'), mainModel))

  // -----------------------------
  // Initiales Rendering
  // -----------------------------
  render(document.getElementById('headline'), headlineModel)
  render(document.getElementById('main'), mainModel)

  // -----------------------------
  // Interaktion
  // -----------------------------

  document.getElementById('toggle').addEventListener('click', () => {
    headlineModel.showCondTitle = !headlineModel.showCondTitle;
  });

  document.getElementById('name').addEventListener('input', e => {
    headlineModel.name = e.target.value;
    console.log(headlineModel.name)
  });


  document.getElementById('push').addEventListener('click', () => {
    mainModel.items.push({'name': 'Tobias', 'age': 30})
  });

  document.getElementById('pop').addEventListener('click', () => {
    mainModel.items.pop()
  });
</script>

</body>
</html>
